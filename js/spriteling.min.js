!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).Spriteling=e()}(this,function(){"use strict";var s=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};function r(o,s,a,l){return new(a||(a=Promise))(function(t,e){function r(t){try{i(l.next(t))}catch(t){e(t)}}function n(t){try{i(l.throw(t))}catch(t){e(t)}}function i(e){e.done?t(e.value):new a(function(t){t(e.value)}).then(r,n)}i((l=l.apply(o,s||[])).next())})}function a(r,n){var i,o,s,t,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=o[2&e[0]?"return":e[0]?"throw":"next"])&&!(s=s.call(o,e[1])).done)return s;switch(o=0,s&&(e=[0,s.value]),e[0]){case 0:case 1:s=e;break;case 4:return a.label++,{value:e[1],done:!1};case 5:a.label++,o=e[1],e=[0];continue;case 7:e=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){a=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){a.label=e[1];break}if(6===e[0]&&a.label<s[1]){a.label=s[1],s=e;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(e);break}s[2]&&a.ops.pop(),a.trys.pop();continue}e=n.call(r,a)}catch(t){e=[6,t],o=0}finally{i=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}var q="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(t,e){return t(e={exports:{}},e.exports),e.exports}t(function(t,e){t.exports=function(){function u(t){return"function"==typeof t}var r=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},n=0,e=void 0,i=void 0,a=function(t,e){p[n]=t,p[n+1]=e,2===(n+=2)&&(i?i(f):g())},t="undefined"!=typeof window?window:void 0,o=t||{},s=o.MutationObserver||o.WebKitMutationObserver,l="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),h="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function c(){var t=setTimeout;return function(){return t(f,1)}}var p=new Array(1e3);function f(){for(var t=0;t<n;t+=2){var e=p[t],r=p[t+1];e(r),p[t]=void 0,p[t+1]=void 0}n=0}var d,y,m,v,g=void 0;function w(t,e){var r=this,n=new this.constructor(_);void 0===n[S]&&D(n);var i=r._state;if(i){var o=arguments[i-1];a(function(){return R(i,n,o,r._result)})}else k(r,n,t,e);return n}function b(t){if(t&&"object"==typeof t&&t.constructor===this)return t;var e=new this(_);return O(e,t),e}l?g=function(){return process.nextTick(f)}:s?(y=0,m=new s(f),v=document.createTextNode(""),m.observe(v,{characterData:!0}),g=function(){v.data=y=++y%2}):h?((d=new MessageChannel).port1.onmessage=f,g=function(){return d.port2.postMessage(0)}):g=void 0===t?function(){try{var t=Function("return this")().require("vertx");return void 0!==(e=t.runOnLoop||t.runOnContext)?function(){e(f)}:c()}catch(t){return c()}}():c();var S=Math.random().toString(36).substring(2);function _(){}var A=void 0,x=1,F=2,P={error:null};function E(t){try{return t.then}catch(t){return P.error=t,P}}function T(t,e,r){var n,i,o,s;e.constructor===t.constructor&&r===w&&e.constructor.resolve===b?(o=t,(s=e)._state===x?H(o,s._result):s._state===F?j(o,s._result):k(s,void 0,function(t){return O(o,t)},function(t){return j(o,t)})):r===P?(j(t,P.error),P.error=null):void 0===r?H(t,e):u(r)?(n=e,i=r,a(function(e){var r=!1,t=function(t,e,r,n){try{t.call(e,r,n)}catch(t){return t}}(i,n,function(t){r||(r=!0,n!==t?O(e,t):H(e,t))},function(t){r||(r=!0,j(e,t))},e._label);!r&&t&&(r=!0,j(e,t))},t)):H(t,e)}function O(t,e){var r,n;t===e?j(t,new TypeError("You cannot resolve a promise with itself")):(n=typeof(r=e),null===r||"object"!==n&&"function"!==n?H(t,e):T(t,e,E(e)))}function W(t){t._onerror&&t._onerror(t._result),C(t)}function H(t,e){t._state===A&&(t._result=e,t._state=x,0!==t._subscribers.length&&a(C,t))}function j(t,e){t._state===A&&(t._state=F,t._result=e,a(W,t))}function k(t,e,r,n){var i=t._subscribers,o=i.length;t._onerror=null,i[o]=e,i[o+x]=r,i[o+F]=n,0===o&&t._state&&a(C,t)}function C(t){var e=t._subscribers,r=t._state;if(0!==e.length){for(var n=void 0,i=void 0,o=t._result,s=0;s<e.length;s+=3)n=e[s],i=e[s+r],n?R(r,n,i,o):i(o);t._subscribers.length=0}}function R(t,e,r,n){var i=u(r),o=void 0,s=void 0,a=void 0,l=void 0;if(i){if((o=function(t,e){try{return t(e)}catch(t){return P.error=t,P}}(r,n))===P?(l=!0,s=o.error,o.error=null):a=!0,e===o)return void j(e,new TypeError("A promises callback cannot return that same promise."))}else o=n,a=!0;e._state!==A||(i&&a?O(e,o):l?j(e,s):t===x?H(e,o):t===F&&j(e,o))}var M=0;function D(t){t[S]=M++,t._state=void 0,t._result=void 0,t._subscribers=[]}var L=function(){function t(t,e){this._instanceConstructor=t,this.promise=new t(_),this.promise[S]||D(this.promise),r(e)?(this.length=e.length,this._remaining=e.length,this._result=new Array(this.length),0===this.length?H(this.promise,this._result):(this.length=this.length||0,this._enumerate(e),0===this._remaining&&H(this.promise,this._result))):j(this.promise,new Error("Array Methods must be provided an Array"))}return t.prototype._enumerate=function(t){for(var e=0;this._state===A&&e<t.length;e++)this._eachEntry(t[e],e)},t.prototype._eachEntry=function(e,t){var r=this._instanceConstructor,n=r.resolve;if(n===b){var i=E(e);if(i===w&&e._state!==A)this._settledAt(e._state,t,e._result);else if("function"!=typeof i)this._remaining--,this._result[t]=e;else if(r===z){var o=new r(_);T(o,e,i),this._willSettleAt(o,t)}else this._willSettleAt(new r(function(t){return t(e)}),t)}else this._willSettleAt(n(e),t)},t.prototype._settledAt=function(t,e,r){var n=this.promise;n._state===A&&(this._remaining--,t===F?j(n,r):this._result[e]=r),0===this._remaining&&H(n,this._result)},t.prototype._willSettleAt=function(t,e){var r=this;k(t,void 0,function(t){return r._settledAt(x,e,t)},function(t){return r._settledAt(F,e,t)})},t}(),z=function(){function e(t){this[S]=M++,this._result=this._state=void 0,this._subscribers=[],_!==t&&("function"!=typeof t&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof e?function(e,t){try{t(function(t){O(e,t)},function(t){j(e,t)})}catch(t){j(e,t)}}(this,t):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return e.prototype.catch=function(t){return this.then(null,t)},e.prototype.finally=function(e){var r=this.constructor;return this.then(function(t){return r.resolve(e()).then(function(){return t})},function(t){return r.resolve(e()).then(function(){throw t})})},e}();return z.prototype.then=w,z.all=function(t){return new L(this,t).promise},z.race=function(i){var o=this;return r(i)?new o(function(t,e){for(var r=i.length,n=0;n<r;n++)o.resolve(i[n]).then(t,e)}):new o(function(t,e){return e(new TypeError("You must pass an array to race."))})},z.resolve=b,z.reject=function(t){var e=new this(_);return j(e,t),e},z._setScheduler=function(t){i=t},z._setAsap=function(t){a=t},z._asap=a,z.polyfill=function(){var t=void 0;if(void 0!==q)t=q;else if("undefined"!=typeof self)t=self;else try{t=Function("return this")()}catch(t){throw new Error("polyfill failed because global object is unavailable in this environment")}var e=t.Promise;if(e){var r=null;try{r=Object.prototype.toString.call(e.resolve())}catch(t){}if("[object Promise]"===r&&!e.cast)return}t.Promise=z},z.Promise=z}()}).polyfill();for(var e=function(t,e){var r,n;if(!t.nodeName)return e(new Error("First argument must be an image element"));if("img"!==t.nodeName.toLowerCase())return e(new Error("Element supplied is not an image"));if(t.src&&t.complete&&void 0!==t.naturalWidth)return e(null,!0);function i(){n?t.detachEvent("onload",i):t.removeEventListener("load",i,!1),e(null,!1)}(n=!t.addEventListener)?t.attachEvent("onload",i):t.addEventListener("load",i,!1),(t.readyState||t.complete)&&(r=t.src,t.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",t.src=r)},n=t(function(s){(function(){var t,e,r,n,i,o;"undefined"!=typeof performance&&null!==performance&&performance.now?s.exports=function(){return performance.now()}:"undefined"!=typeof process&&null!==process&&process.hrtime?(s.exports=function(){return(t()-i)/1e6},e=process.hrtime,n=(t=function(){var t;return 1e9*(t=e())[0]+t[1]})(),o=1e9*process.uptime(),i=n-o):Date.now?(s.exports=function(){return Date.now()-r},r=Date.now()):(s.exports=function(){return(new Date).getTime()-r},r=(new Date).getTime())}).call(q)}),i="undefined"==typeof window?q:window,o=["moz","webkit"],l="AnimationFrame",u=i["request"+l],h=i["cancel"+l]||i["cancelRequest"+l],c=0;!u&&c<o.length;c++)u=i[o[c]+"Request"+l],h=i[o[c]+"Cancel"+l]||i[o[c]+"CancelRequest"+l];if(!u||!h){var p=0,f=0,d=[];u=function(t){if(0===d.length){var e=n(),r=Math.max(0,1e3/60-(e-p));p=r+e,setTimeout(function(){for(var t=d.slice(0),e=d.length=0;e<t.length;e++)if(!t[e].cancelled)try{t[e].callback(p)}catch(t){setTimeout(function(){throw t},0)}},Math.round(r))}return d.push({handle:++f,callback:t,cancelled:!1}),f},h=function(t){for(var e=0;e<d.length;e++)d[e].handle===t&&(d[e].cancelled=!0)}}var y=function(t){return u.call(i,t)};y.cancel=function(){h.apply(i,arguments)};var m={play:!0,delay:50,tempo:1,run:-1,reversed:!(y.polyfill=function(t){t||(t=i),t.requestAnimationFrame=u,t.cancelAnimationFrame=h}),script:[],lastTime:0,nextDelay:0,currentSprite:1,currentFrame:-1,onPlay:null,onStop:null,onFrame:null,onOutOfView:null};return function(){function t(t,e,r){void 0===r&&(r=!1);var n=this;if(this.spriteSheet={loaded:!1,url:null,cols:null,rows:null,cutOffFrames:0,top:null,bottom:null,left:null,right:null,startSprite:1,downsizeRatio:1,totalSprites:0,sheetWidth:0,sheetHeight:0,frameWidth:0,frameHeight:0,animations:{},onLoaded:null},this.loop=function(t){void 0===t&&(t=0);var e=y(n.loop),r=n.playhead;n.element&&n.spriteSheet.loaded&&(t-r.lastTime>=r.nextDelay&&n.render(t),r.play||y.cancel(e))},e&&(this.element="string"==typeof e?document.querySelector(e):e),this.element||(void 0!==this.element&&this.log("warn",'element "'+e+'" not found, created new element instead'),this.element=document.createElement("div"),document.body.appendChild(this.element)),this.element.className+=" spriteling",this.spriteSheet=s({},this.spriteSheet,t),this.playhead=s({},m),this.debug=r||!1,t.cols||this.log("error","options.cols not set"),t.rows||this.log("error","options.rows not set"),!t.url){var i=window.getComputedStyle(this.element).getPropertyValue("background-image");i&&"none"!==i?this.spriteSheet.url=i.replace(/"/g,"").replace(/url\(|\)$/gi,""):this.log("error","no spritesheet image found, please specify it with options.url or set as css background")}this.loadingPromise=this.loadSpriteSheet().then(function(){n.spriteSheet.loaded=!0,1<n.spriteSheet.startSprite&&n.spriteSheet.startSprite<=n.spriteSheet.totalSprites&&n.drawFrame({sprite:n.spriteSheet.startSprite}),"function"==typeof n.spriteSheet.onLoaded&&n.spriteSheet.onLoaded()})}return t.prototype.showSprite=function(e){return r(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,this.loadingPromise];case 1:return t.sent(),this.playhead.play=!1,this.drawFrame({sprite:e}),[2]}})})},t.prototype.currentSprite=function(){return this.playhead.currentSprite},t.prototype.addScript=function(t,e){this.spriteSheet.animations[t]=e},t.prototype.play=function(i,o){return r(this,void 0,void 0,function(){var e,r,n;return a(this,function(t){switch(t.label){case 0:return[4,this.loadingPromise];case 1:return t.sent(),i||o?(e=void 0,r={},"string"!=typeof i||o?"string"==typeof i&&"object"==typeof o?(e=this.spriteSheet.animations[i],r=o):"object"!=typeof i||o||(e=i.script||this.playhead.script,r=i):this.spriteSheet.animations[i]?(this.log("info",'playing animation "'+i+'"'),e=this.spriteSheet.animations[i]):this.log("warn",'animation "'+i+'" not found'),e||(this.log("info",'playing animation "all"'),e=this.spriteSheet.animations.all),n=-1,r.reversed&&(n=e.length),this.playhead=s({},m,{script:e},r,{currentFrame:n})):this.playhead.play||(0===this.playhead.run&&(this.playhead.run=1),this.playhead.play=!0),0!==this.playhead.run&&this.playhead.play&&this.loop(),"function"==typeof this.playhead.onPlay&&this.playhead.onPlay(),[2]}})})},t.prototype.isPlaying=function(){return this.playhead.play},t.prototype.setTempo=function(e){return r(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,this.loadingPromise];case 1:return t.sent(),this.playhead.tempo=e,[2]}})})},t.prototype.getTempo=function(){return this.playhead.tempo},t.prototype.next=function(){return r(this,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return[4,this.loadingPromise];case 1:return t.sent(),this.playhead.currentFrame+=1,this.playhead.currentFrame===this.playhead.script.length&&(this.playhead.run-=1,this.playhead.currentFrame=0),this.playhead.play&&0===this.playhead.run?this.stop():(e=this.playhead.script[this.playhead.currentFrame],this.drawFrame(e)),[2]}})})},t.prototype.previous=function(){return r(this,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return[4,this.loadingPromise];case 1:return t.sent(),this.playhead.currentFrame-=1,this.playhead.currentFrame<0&&(this.playhead.currentFrame=this.playhead.script.length-1,this.playhead.run-=1),this.playhead.play&&0===this.playhead.run?this.stop():(e=this.playhead.script[this.playhead.currentFrame],this.drawFrame(e)),[2]}})})},t.prototype.goTo=function(n){return r(this,void 0,void 0,function(){var e,r;return a(this,function(t){switch(t.label){case 0:return[4,this.loadingPromise];case 1:return t.sent(),e=Math.floor(n/this.playhead.script.length),n=Math.floor(n-e*this.playhead.script.length),this.playhead.currentFrame=n,(r=this.playhead.script[this.playhead.currentFrame])&&(this.log("info","frame: "+this.playhead.currentFrame+", sprite: "+r.sprite),this.drawFrame(r)),[2]}})})},t.prototype.reverse=function(){return r(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,this.loadingPromise];case 1:return t.sent(),this.playhead.reversed=!this.playhead.reversed,[2]}})})},t.prototype.isReversed=function(){return this.playhead.reversed},t.prototype.stop=function(){return r(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,this.loadingPromise];case 1:return t.sent(),this.playhead.play=!1,"function"==typeof this.playhead.onStop&&this.playhead.onStop(),[2]}})})},t.prototype.reset=function(){return r(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,this.loadingPromise];case 1:return t.sent(),this.goTo(0),[2]}})})},t.prototype.destroy=function(){this.playhead.play=!1,this.element.parentNode.removeChild(this.element)},t.prototype.loadSpriteSheet=function(){var o=this;return new Promise(function(n){var i=new Image;i.src=o.spriteSheet.url,e(i,function(){var t=o.spriteSheet,e=o.element;o.log("info","loaded: "+t.url+", sprites "+t.cols+" x "+t.rows),t.sheetWidth=i.width,t.sheetHeight=i.height,t.frameWidth=t.sheetWidth/t.cols/t.downsizeRatio,t.frameHeight=t.sheetHeight/t.rows/t.downsizeRatio,t.totalSprites=t.cols*t.rows-t.cutOffFrames,t.frameWidth%1!=0&&o.log("error","frameWidth "+t.frameWidth+" is not a whole number"),t.frameHeight%1!=0&&o.log("error","frameHeight "+t.frameHeight+" is not a whole number"),e.style.position="absolute",e.style.width=t.frameWidth+"px",e.style.height=t.frameHeight+"px",e.style.backgroundImage="url("+t.url+")",e.style.backgroundPosition="0 0",1<t.downsizeRatio&&(e.style.backgroundSize=t.sheetWidth/t.downsizeRatio+"px "+t.sheetHeight/t.downsizeRatio+"px"),null!==t.top&&("center"===t.top?(e.style.top="50%",e.style.marginTop=t.frameHeight/2*-1+"px"):e.style.top=t.top+"px"),null!==t.right&&(e.style.right=t.right+"px"),null!==t.bottom&&(e.style.bottom=t.bottom+"px"),null!==t.left&&("center"===t.left?(e.style.left=t.left+"px",e.style.marginLeft=t.frameWidth/2*-1+"px"):e.style.left=t.left+"px"),o.autoScript();var r={script:t.animations.all};o.playhead=s({},m,r),n()})})},t.prototype.autoScript=function(){for(var t=[],e=0;e<this.spriteSheet.totalSprites;e++)t[e]={sprite:e+1};this.addScript("all",t)},t.prototype.render=function(i){return r(this,void 0,void 0,function(){var e,r,n;return a(this,function(t){switch(t.label){case 0:return e=this.element,r=this.playhead,null!==e.offsetParent&&this.inViewport()?0===r.run?[3,5]:r.reversed?[4,this.previous()]:[3,2]:[3,6];case 1:return t.sent(),[3,4];case 2:return[4,this.next()];case 3:t.sent(),t.label=4;case 4:n=r.script[r.currentFrame],this.log("info","run: "+r.run+", frame",n),r.lastTime=i,t.label=5;case 5:return[3,7];case 6:"function"==typeof r.onOutOfView&&r.onOutOfView(),t.label=7;case 7:return[2]}})})},t.prototype.drawFrame=function(t){var e=this.spriteSheet,r=this.playhead,n=this.element;if(this.playhead.nextDelay=t.delay?t.delay:this.playhead.delay,this.playhead.nextDelay/=this.playhead.tempo,t.sprite!==r.currentSprite){var i=n.getBoundingClientRect(),o=Math.ceil(t.sprite/e.cols),s=t.sprite-(o-1)*e.cols,a=(s-1)*e.frameWidth*-1,l=(o-1)*e.frameHeight*-1;(o>e.rows||s>e.cols)&&this.log("warn","position "+t.sprite+" out of bound"),r.currentSprite=t.sprite,n.style.backgroundPosition=a+"px "+l+"px",t.top&&(n.style.top=i.top+t.top+"px"),t.right&&(n.style.right=i.right+t.right+"px"),t.bottom&&(n.style.bottom=i.bottom+t.bottom+"px"),t.left&&(n.style.left=i.left+t.left+"px")}return"function"==typeof r.onFrame&&r.onFrame(r.currentFrame),!0},t.prototype.inViewport=function(){var t=this.spriteSheet,e=this.element.getBoundingClientRect();return 0<=e.top+t.frameHeight&&0<=e.left+t.frameWidth&&e.bottom-t.frameHeight<=(window.innerHeight||document.documentElement.clientHeight)&&e.right-t.frameWidth<=(window.innerWidth||document.documentElement.clientWidth)},t.prototype.log=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];"undefined"==typeof console||"info"===t&&!this.debug||console[t].apply(console,["Spriteling"].concat(e))},t}()});
